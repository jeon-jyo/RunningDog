<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="walkTrail">

	<resultMap id="LocationMap" type="com.runningdog.vo.LocationVo">
		<result column="si" property="si"></result>
		<result column="gu" property="gu"></result>
		<result column="dong" property="dong"></result>
	</resultMap>
	
	<resultMap id="UsersMap" type="com.runningdog.vo.UsersVo">
		<result column="userNo" property="userNo"></result>
		<result column="id" property="id"></result>
		<result column="password" property="password"></result>
		<result column="userName" property="name"></result>
		<result column="code" property="code"></result>
		<result column="birth" property="birth"></result>
		<result column="gender" property="gender"></result>
		<result column="status" property="status"></result>
		<collection property="locationVo" resultMap="LocationMap"></collection>
	</resultMap>
	
	<resultMap id="TrailMap" type="com.runningdog.vo.TrailVo">
		<result column="trailNo" property="trailNo"></result>
		<result column="name" property="name"></result>
		<result column="spot" property="spot"></result>
		<result column="distance" property="distance"></result>
		<result column="eta" property="eta"></result>
		<result column="parking" property="parking"></result>
		<result column="restroom" property="restroom"></result>
		<result column="trashCan" property="trashCan"></result>
		<result column="explanation" property="explanation"></result>
		<result column="regDate" property="regDate"></result>
		<result column="updateDate" property="updateDate"></result>
		<result column="status" property="status"></result>
		<collection property="usersVo" resultMap="UsersMap"></collection>
		<collection property="locationVo" resultMap="LocationMap"></collection>
	</resultMap>
	
	<resultMap id="WalkLogMap" type="com.runningdog.vo.WalkLogVo">
		<result column="walkLogNo" property="walkLogNo"></result>
		<result column="regDate" property="regDate"></result>
		<result column="startTime" property="startTime"></result>
		<result column="endTime" property="endTime"></result>
		<result column="logTime" property="logTime"></result>
		<result column="distance" property="distance"></result>
		<result column="content" property="content"></result>
		<result column="security" property="security"></result>
		<result column="status" property="status"></result>
		<collection property="usersVo" resultMap="UsersMap"></collection>
		<collection property="locationVo" resultMap="LocationMap"></collection>
	</resultMap>

	<!-- trailMain -->
	
	<!-- 유저 설정 위치 -->
	<select id="userLocation" parameterType="int" resultType="com.runningdog.vo.LocationVo">
		 <![CDATA[
			SELECT l.locationNo
			       ,l.si
			       ,l.gu
			       ,l.dong
			  FROM users u, location l
			 WHERE u.locationNo = l.locationNo
			   AND u.userNo = #{userNo}
		 ]]>
	</select>
	
	<!-- 게스트 설정 위치 -->
	<select id="guestLocation" resultType="com.runningdog.vo.LocationVo">
		 <![CDATA[
			SELECT locationNo
			       ,si
			       ,gu
			       ,dong
			  FROM location
			 WHERE gu LIKE '%전체%'
		 ]]>
	</select>

	<!-- 산책로 추천 / 등록 목록 -->
	<select id="trailList" parameterType="java.util.Map" resultType="com.runningdog.vo.TrailVo">
		<![CDATA[
			SELECT ort.trailNo
			       ,ort.name
			       ,ort.distance
			       ,ort.eta
			       ,ort.regDate
			  FROM (SELECT ROWNUM rn
			               ,ot.trailNo
			               ,ot.name
			               ,ot.distance
			               ,ot.eta
			               ,ot.regDate
			          FROM (SELECT t.trailNo
			                       ,t.name
			                       ,t.distance
			                       ,t.eta
			                       ,TO_CHAR(t.regdate, 'YY-MM-DD HH24:MI:SS') regDate
		]]>
		<if test='filter == 0'>
			<![CDATA[
							  FROM trail t, coords c, ( SELECT COUNT(tt.walkLogNo) cnt
			                                                   ,tt.trailNo
			                                              FROM trailUsed tt, trailTag ta
			                                             WHERE tt.trailNo = ta.trailNo
			]]>
		</if>		
		<if test='filter == 1'>
			<![CDATA[
							  FROM trail t, coords c, ( SELECT COUNT(tt.userNo) cnt
			                                                   ,tt.trailNo
			                                              FROM trailStar tt, trailTag ta
			                                             WHERE tt.trailNo = ta.trailNo
			]]>
		</if>
		<if test='filter == 2'>
			<![CDATA[
				  			  FROM trail t, coords c, ( SELECT COUNT(tt.userNo) cnt
			                                                   ,tt.trailNo
			                                              FROM trailCmt tt, trailTag ta
			                                             WHERE tt.trailNo = ta.trailNo
			                                               AND tt.status = 'T'
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
				  			  FROM trail t, coords c, ( SELECT tt.trailNo
			                                              FROM trailTag tt
			                                             WHERE tt.trailNo > 0
			]]>
		</if>
		<if test='tags.size != 0'>
			<![CDATA[
														   AND ta.tagName IN
			]]>
			<foreach collection="tags" item="item" index="index" separator="," open="(" close=")">
				#{item}
			</foreach>
		</if>
		<![CDATA[
														 GROUP BY tt.trailNo ) gt
			                 WHERE t.trailNo = c.useNo
			                   AND t.trailNo = gt.trailNo
			                   AND c.type = 'trail'
			                   AND c.coordorder = 1
			                   AND c.lng BETWEEN #{coordsMap.swX} AND #{coordsMap.neX}
			   				   AND c.lat BETWEEN #{coordsMap.swY} AND #{coordsMap.neY}
			                   AND t.status = 'T'
		]]>
		<if test='listKey == "my"'>
			<![CDATA[
				  			   AND t.userNo = #{userNo}
			]]>
		</if>
		<if test='filter == 0 || filter == 1 || filter == 2'>
			<![CDATA[
				  			 ORDER BY gt.cnt DESC
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
				  			 ORDER BY t.regDate DESC
			]]>
		</if>
		<![CDATA[
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 10
		 ]]>
	</select>

	<!-- 산책로 찜 목록 -->
	<select id="trailStarList" parameterType="java.util.Map" resultType="com.runningdog.vo.TrailVo">
		<![CDATA[
			SELECT ort.trailNo
			       ,ort.name
			       ,ort.distance
			       ,ort.eta
			       ,ort.regDate
			  FROM (SELECT ROWNUM rn
			               ,ot.trailNo
			               ,ot.name
			               ,ot.distance
			               ,ot.eta
			               ,ot.regDate
			          FROM (SELECT t.trailNo
			                       ,t.name
			                       ,t.distance
			                       ,t.eta
			                       ,TO_CHAR(t.regdate, 'YY-MM-DD HH24:MI:SS') regDate
		]]>
		<if test='filter == 0'>
			<![CDATA[
							  FROM trail t, coords c, trailStar ts, ( SELECT COUNT(tt.walkLogNo) cnt
						                                                     ,tt.trailNo
						                                                FROM trailUsed tt, trailTag ta
						                                               WHERE tt.trailNo = ta.trailNo
			]]>
		</if>
		<if test='filter == 1'>
			<![CDATA[
							  FROM trail t, coords c, trailStar ts, ( SELECT COUNT(tt.userNo) cnt
						                                                     ,tt.trailNo
						                                                FROM trailStar tt, trailTag ta
						                                               WHERE tt.trailNo = ta.trailNo
			]]>
		</if>
		<if test='filter == 2'>
			<![CDATA[
				  			  FROM trail t, coords c, trailStar ts, ( SELECT COUNT(tt.userNo) cnt
						                                                     ,tt.trailNo
						                                                FROM trailCmt tt, trailTag ta
						                                               WHERE tt.trailNo = ta.trailNo
						                                                 AND tt.status = 'T'
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
				  			  FROM trail t, coords c, trailStar ts, ( SELECT tt.trailNo
						                                                FROM trailTag tt
						                                               WHERE tt.trailNo > 0
			]]>
		</if>
		<if test='tags.size != 0'>
			<![CDATA[
														  				 AND ta.tagName IN
			]]>
			<foreach collection="tags" item="item" index="index" separator="," open="(" close=")">
				#{item}
			</foreach>
		</if>
		<![CDATA[
																	   GROUP BY tt.trailNo ) gt
			                 WHERE t.trailNo = c.useNo
			                   AND t.trailNo = gt.trailNo
			                   AND c.type = 'trail'
			                   AND c.coordorder = 1
			                   AND c.lng BETWEEN #{coordsMap.swX} AND #{coordsMap.neX}
			   				   AND c.lat BETWEEN #{coordsMap.swY} AND #{coordsMap.neY}
			                   AND t.status = 'T'
			                   AND t.trailNo = ts.trailNo
                   			   AND ts.userNo = #{userNo}
		]]>
		<if test='filter == 0 || filter == 1 || filter == 2'>
			<![CDATA[
				  			 ORDER BY gt.cnt DESC
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
				  			 ORDER BY t.regDate DESC
			]]>
		</if>
		<![CDATA[
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 10
		 ]]>
	</select>
	
	<!-- 산책로 좌표 목록 -->
	<select id="coordsList" parameterType="int" resultType="com.runningdog.vo.CoordsVo">
		 <![CDATA[
			SELECT c.useNo
			       ,c.coordOrder
			       ,c.lat
			       ,c.lng
			  FROM trail t, coords c
			 WHERE t.trailNo = c.useNo
			   AND c.type = 'trail'
			   AND c.useNo = #{trailNo}
			   AND t.status = 'T'
			 ORDER BY c.coordOrder
		 ]]>
	</select>
	
	<!-- 산책로 정보 -->
	<select id="trailInfo" parameterType="int" resultMap="TrailMap">
		 <![CDATA[
			SELECT t.trailNo
			       ,t.name
			       ,t.distance
			       ,t.eta
			       ,TO_CHAR(t.regdate, 'YY-MM-DD') regDate
			       ,u.userNo
			       ,u.name userName
			  FROM trail t, users u
			 WHERE t.userNo = u.userNo
			   AND t.trailNo = #{trailNo}
		 ]]>
	</select>

	<!-- 산책로 유저 프로필 -->
	<select id="trailUserImg" parameterType="int" resultType="com.runningdog.vo.ImagesVo">
		 <![CDATA[
			SELECT u.userNo
			       ,u.name
			       ,i.orgName
			       ,i.saveName
			       ,i.filePath
			  FROM users u, images i
			 WHERE i.type = 'users'
			   AND i.useNo = #{userNo}
		 ]]>
	</select>
	
	<!-- 산책로 이용자수 -->
	<select id="trailUsedCnt" parameterType="int" resultType="int">
		 <![CDATA[
			SELECT COUNT(*)
			  FROM trailUsed
			 WHERE trailNo = #{trailNo}
		 ]]>
	</select>
	
	<!-- 산책로 찜 갯수 -->
	<select id="trailStarCnt" parameterType="int" resultType="int">
		 <![CDATA[
			SELECT COUNT(*)
			  FROM trailStar
			 WHERE trailNo = #{trailNo}
		 ]]>
	</select>
	
	<!-- 산책로 후기 갯수 -->
	<select id="trailCmtCnt" parameterType="int" resultType="int">
		 <![CDATA[
			SELECT COUNT(*)
			  FROM trailCmt
			 WHERE trailNo = #{trailNo}
		 ]]>
	</select>
	
	<!-- 산책로 선택태그 목록 -->
	<select id="trailTagList" resultType="com.runningdog.vo.TrailVo">
		 <![CDATA[
			SELECT trailNo 
			       ,name
			       ,distance
			       ,eta
			  FROM trail
			 WHERE locationNo = 1174010900
			   AND status = 'T'
		 ]]>
	</select>
	
	<!-- 산책일지 목록 -->
	<select id="walkLogList" parameterType="java.util.Map" resultType="com.runningdog.vo.WalkLogVo">
		<![CDATA[
			SELECT ort.walkLogNo
			       ,ort.userNo
			       ,ort.distance
			       ,ort.logTime
			       ,ort.regDate
			  FROM (SELECT ROWNUM rn
			               ,ot.walkLogNo
			               ,ot.userNo
			               ,ot.distance
			               ,ot.logTime
			               ,ot.regDate
			          FROM (SELECT w.walkLogNo
			                       ,w.userNo
			                       ,w.distance
			                       ,w.logTime
			                       ,TO_CHAR(w.regdate, 'YY-MM-DD HH24:MI:SS') regDate
		]]>
		<if test='filter == 0'>
			<![CDATA[
							  FROM walkLog w, coords c, ( SELECT COUNT(trailNo) cnt
			                                                     ,walkLogNo
			                                                FROM trailUsed
			                                               GROUP BY walkLogNo ) gt
			                 WHERE w.walkLogNo = c.useNo
			                   AND w.walkLogNo = gt.walkLogNo
			]]>
		</if>
		<if test='filter == 1'>
			<![CDATA[
							  FROM walkLog w, coords c, ( SELECT COUNT(userNo) cnt
			                                                     ,useNo
			                                                FROM userLike
			                                               WHERE type = 'walkLog'
			                                               GROUP BY useNo ) gt
			                 WHERE w.walkLogNo = c.useNo
			                   AND w.walkLogNo = gt.useNo
			]]>
		</if>
		<if test='filter == 2 || filter == 3'>
			<![CDATA[
							  FROM walkLog w, coords c
                 			 WHERE w.walkLogNo = c.useNo
			]]>
		</if>
		<![CDATA[
			                   AND c.type = 'walkLog'
			                   AND c.coordorder = 1
			                   AND c.lng BETWEEN #{coordsMap.swX} AND #{coordsMap.neX}
			   				   AND c.lat BETWEEN #{coordsMap.swY} AND #{coordsMap.neY}
			                   AND w.status = 'T'
			                   AND w.userNo = #{userNo}
		]]>
		<if test='filter == 0 || filter == 1'>
			<![CDATA[
							 ORDER BY gt.cnt DESC
			]]>
		</if>
		<if test='filter == 2'>
			<![CDATA[
							 ORDER BY regDate DESC
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
							 ORDER BY regDate ASC
			]]>
		</if>
		<![CDATA[
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 10
		 ]]>
	</select>
	
	<!-- 산책일지 좌표 -->
	<select id="coords" parameterType="int" resultType="com.runningdog.vo.CoordsVo">
		 <![CDATA[
			SELECT c.useNo
			       ,c.coordOrder
			       ,c.lat
			       ,c.lng
			  FROM walkLog w, coords c
			 WHERE w.walkLogNo = c.useNo
			   AND c.type = 'walkLog'
			   AND c.useNo = #{walkLogNo}
			   AND w.status = 'T'
			 ORDER BY c.coordOrder
		 ]]>
	</select>
	
	<!-- 산책일지 목록 테스트 -->
	<select id="test" parameterType="java.util.Map" resultType="com.runningdog.vo.WalkLogVo">
		<![CDATA[
			SELECT ort.walkLogNo
			       ,ort.userNo
			       ,ort.distance
			       ,ort.logTime
			       ,ort.regDate
			  FROM (SELECT ROWNUM rn
			               ,ot.walkLogNo
			               ,ot.userNo
			               ,ot.distance
			               ,ot.logTime
			               ,ot.regDate
			          FROM (SELECT w.walkLogNo
			                       ,w.userNo
			                       ,w.distance
			                       ,w.logTime
			                       ,TO_CHAR(w.regdate, 'YY-MM-DD HH24:MI:SS') regDate
		]]>
		<if test='filter == 0'>
			<![CDATA[
							  FROM walkLog w, coords c, ( SELECT COUNT(trailNo) cnt
			                                                     ,walkLogNo
			                                                FROM trailUsed
			                                               GROUP BY walkLogNo ) gt
			                 WHERE w.walkLogNo = c.useNo
			                   AND w.walkLogNo = gt.walkLogNo
			]]>
		</if>
		<if test='filter == 1'>
			<![CDATA[
							  FROM walkLog w, coords c, ( SELECT COUNT(userNo) cnt
			                                                     ,useNo
			                                                FROM userLike
			                                               WHERE type = 'walkLog'
			                                               GROUP BY useNo ) gt
			                 WHERE w.walkLogNo = c.useNo
			                   AND w.walkLogNo = gt.useNo
			]]>
		</if>
		<if test='filter == 2 || filter == 3'>
			<![CDATA[
							  FROM walkLog w, coords c
                 			 WHERE w.walkLogNo = c.useNo
			]]>
		</if>
		<![CDATA[
			                   AND c.type = 'walkLog'
			                   AND c.coordorder = 1
			                   AND c.lng BETWEEN #{coordsMap.swX} AND #{coordsMap.neX}
			   				   AND c.lat BETWEEN #{coordsMap.swY} AND #{coordsMap.neY}
			                   AND w.status = 'T'
			                   AND w.userNo = #{userNo}
		]]>
		<if test='filter == 0 || filter == 1'>
			<![CDATA[
							 ORDER BY gt.cnt DESC
			]]>
		</if>
		<if test='filter == 2'>
			<![CDATA[
							 ORDER BY regDate DESC
			]]>
		</if>
		<if test='filter == 3'>
			<![CDATA[
							 ORDER BY regDate ASC
			]]>
		</if>
		<![CDATA[
			               ) ot
			       ) ort
			 WHERE ort.rn >= 1
			   AND ort.rn <= 10
		 ]]>
	</select>

</mapper>
